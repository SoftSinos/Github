unit fLogPesquisa;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, fPesquisa, Data.DB, Datasnap.DBClient, Vcl.ComCtrls, Vcl.Buttons, Vcl.StdCtrls, Vcl.Grids, Vcl.DBGrids, Vcl.ExtCtrls, cxGraphics,
  cxControls, cxLookAndFeels, cxLookAndFeelPainters, cxContainer, cxEdit, dxCore, cxDateUtils, cxTextEdit, cxMaskEdit, cxDropDownEdit, cxCalendar, dxSkinsCore,
  dxSkinsDefaultPainters;

type
  TFrmLogPesquisa = class(TFrmPesquisa)
    Label13     : TLabel;
    DtpDtInicial: TcxDateEdit;
    Label2      : TLabel;
    Label3      : TLabel;
    DtpDtFinal  : TcxDateEdit;
    procedure BtnPesquisarClick(Sender: TObject);
    procedure EdtPesquisaKeyPress(Sender: TObject; var Key: Char);
    procedure BtnImprimirClick(Sender: TObject);
    procedure BtnAjudaClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure BtnLimparClick(Sender: TObject);
  private
    { Private declarations }
    procedure Pesquisar(AConsulta: String);
    procedure ControleBotao;
  public
    { Public declarations }
  end;

var
  FrmLogPesquisa: TFrmLogPesquisa;

implementation

{$R *.dfm}

uses dPrincipal, uFuncao, fProcessando, uLog, uMensagem, dRelatorios, uEmpresa, fAjuda;

var
  unLog         : TLog;
  unEmpresa     : TEmpresa;
  dnRelatorios  : TDtmRelatorios;

procedure TFrmLogPesquisa.BtnAjudaClick(Sender: TObject);
begin
  try
    FrmAjuda := TFrmAjuda.Create(Application);
    FrmAjuda.Caption        := '  Ajuda Sobre à Tela de ' +  Caption;
    FrmAjuda.gNmTelaChamada := Name;
    FrmAjuda.ShowModal;
  finally
    FrmAjuda.Free;
  end;
end;

procedure TFrmLogPesquisa.BtnImprimirClick(Sender: TObject);
begin
  inherited;
  try
    Application.CreateForm(TFrmProcessando, FrmProcessando);
    FrmProcessando.Show;
    Application.ProcessMessages;

    dnRelatorios := TDtmRelatorios.Create(Self);
    unEmpresa    := TEmpresa.Create;
    unEmpresa.CarregaDbGrid(DtmPrincipal.Conexao, 2, DtmPrincipal.IdEmpresaLogada, '', dnRelatorios.CDSRelEmpresa);
    unLog.CarregaDbGrid(DtmPrincipal.Conexao, 0, 0, EdtPesquisa.Text, DtpDtInicial.Date, DtpDtFinal.Date, 1, dnRelatorios.CDSRelPesquisa);

    FrmProcessando.Destroy;

    dnRelatorios.frxPDFExport.ShowDialog := True;
    dnRelatorios.frxReport.LoadFromFile(DtmPrincipal.NmCaminhoExecutavel + 'Relatorio\RelPesqImpLog.fr3');
    dnRelatorios.frxReport.ShowReport();
  finally
    dnRelatorios.Destroy;
  end;
end;

procedure TFrmLogPesquisa.BtnLimparClick(Sender: TObject);
begin
  inherited;
  ControleBotao;
end;

procedure TFrmLogPesquisa.BtnPesquisarClick(Sender: TObject);
begin
  Pesquisar(EdtPesquisa.Text);
  inherited;
end;

procedure TFrmLogPesquisa.ControleBotao;
begin
  BtnIncluir.Enabled := False;
  BtnAlterar.Enabled := False;
end;

procedure TFrmLogPesquisa.EdtPesquisaKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
  begin
    BtnPesquisarClick(Sender);
  end;
  inherited;
end;

procedure TFrmLogPesquisa.FormShow(Sender: TObject);
begin
  inherited;
  DtpDtInicial.Date := Now;
  DtpDtFinal.Date   := Now;

  ControleBotao;
end;

procedure TFrmLogPesquisa.Pesquisar(AConsulta: String);
var
  I: Integer;
  lConsulta: Integer;
begin
  PrbPesquisa.Position := 0;
  lConsulta := 0;
  try
    Application.CreateForm(TFrmProcessando, FrmProcessando);
    FrmProcessando.Show;
    Application.ProcessMessages;

    for I := 1 to 100 do
    begin
      Sleep(15);
      PrbPesquisa.Position := PrbPesquisa.Position + 1;
      if lConsulta = 0 then
      begin
        lConsulta := 1;
        unLog := TLog.Create;
        unLog.CarregaDbGrid(DtmPrincipal.Conexao, 0, 0, EdtPesquisa.Text, DtpDtInicial.Date, DtpDtFinal.Date, 1, CdsPesquisa);
      end;
    end;
  finally
    unLog.Free;
    FrmProcessando.Destroy;
  end;
end;

end.
