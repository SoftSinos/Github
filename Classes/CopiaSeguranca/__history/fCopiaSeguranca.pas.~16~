unit fCopiaSeguranca;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics, Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.ExtCtrls, Vcl.StdCtrls, Vcl.Buttons,
  Vcl.ComCtrls, TLHelp32, DateUtils, WinInet, MaskUtils, DbTables, Contnrs, FireDAC.Stan.Intf, FireDAC.Stan.Option, FireDAC.Stan.Param, FireDAC.Stan.Error,
  FireDAC.DatS, FireDAC.Phys.Intf, FireDAC.DApt.Intf, FireDAC.Stan.Async, FireDAC.DApt, Data.DB, FireDAC.Comp.DataSet, FireDAC.Comp.Client, Datasnap.DBClient, FireDAC.UI.Intf,
  FireDAC.VCLUI.Wait, FireDAC.Comp.UI, cxGraphics, cxControls, cxLookAndFeels, cxLookAndFeelPainters, cxContainer, cxEdit, cxLabel, dxSkinsCore, dxSkinsDefaultPainters;

type
  TFrmCopiaSeguranca = class(TForm)
    Panel1            : TPanel;
    BtnAjuda          : TSpeedButton;
    BtnFechar         : TBitBtn;
    Label1            : TLabel;
    LblCaminhoCopia   : TLabel;
    ProgressBarSplash : TProgressBar;
    cxLabel1          : TcxLabel;
    BtnGravado        : TBitBtn;
    BtnGerar          : TBitBtn;
    GroupBox1: TGroupBox;
    RdbReduzir: TRadioButton;
    StbPrincipal: TStatusBar;
    procedure BtnGerarClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure BtnFecharClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure BtnGravadoClick(Sender: TObject);
    procedure BtnAjudaClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
  private
    { Private declarations }
    procedure InicializarTela;
  public
    { Public declarations }
    DuracaoTempo : TTime;
  end;

var
  FrmCopiaSeguranca: TFrmCopiaSeguranca;

implementation

{$R *.dfm}

uses dPrincipal, uFuncao, fProcessando, uMensagem, fAjuda, uProcedure;

procedure TFrmCopiaSeguranca.BtnAjudaClick(Sender: TObject);
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'BtnAjudaClick';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  try
    FrmAjuda := TFrmAjuda.Create(Application);
    FrmAjuda.Caption        := 'Ajuda Sobre à Tela de ' +  Caption;;
    FrmAjuda.gNmTelaChamada := Name;
    FrmAjuda.ShowModal;
  finally
    FrmAjuda.Free;
  end;
end;

procedure TFrmCopiaSeguranca.BtnFecharClick(Sender: TObject);
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'BtnFecharClick';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  Close;
end;

procedure TFrmCopiaSeguranca.BtnGerarClick(Sender: TObject);
var
  qryReduzir : TFDQuery;
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'BtnGerarClick';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  try
    Application.ProcessMessages;
    BtnGerar.Cursor     := crHourGlass;

    uProcedure.CopiaSeguranca;

    if RdbReduzir.Checked then
    begin
      qryReduzir   := TFDQuery.Create(nil);
      qryReduzir.Sql.Clear;
      qryReduzir.Connection := DtmPrincipal.Conexao;
      qryReduzir.Sql.Add('Exec PC_ShrinkFile       ');

      qryReduzir.ExecSQL;
      qryReduzir.FreeOnRelease;
    end;

  finally
    BtnGerar.Cursor     := crDefault;
    MsgInformacao(uMensagem.CopiaSegurancaRealizadaComSucesso)
  end;
end;

procedure TFrmCopiaSeguranca.BtnGravadoClick(Sender: TObject);
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'BtnGravadoClick';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  AbrirExplorer(LblCaminhoCopia.Caption, True, True);
end;

procedure TFrmCopiaSeguranca.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'FormClose';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  Action := caFree;
end;

procedure TFrmCopiaSeguranca.FormCreate(Sender: TObject);
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'FormCreate';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

end;

procedure TFrmCopiaSeguranca.FormShow(Sender: TObject);
begin
  DtmPrincipal.unLog.NmOperacao := 'Entrou';
  DtmPrincipal.unLog.NmClasse   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.NmMetodo   := 'FormShow';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  InicializarTela;
end;

procedure TFrmCopiaSeguranca.InicializarTela;
begin
  DtmPrincipal.unLog.NmOperacao := 'Call';
  DtmPrincipal.unLog.NmClasse   := 'InicializarTela';
  DtmPrincipal.unLog.NmMetodo   := 'TFrmCopiaSeguranca';
  DtmPrincipal.unLog.GerarLog(DtmPrincipal.Conexao);

  LblCaminhoCopia.Caption := DtmPrincipal.NmCaminhoExecutavel + 'Seguranca\' + uFuncao.DiaDaSemana(DayofWeek(Date), 0);

end;

end.
